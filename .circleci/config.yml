version: 2.0
executors:
  my-executor:
    docker:
      - image: circleci/node:8.10
    working_directory: ~/swayze-life

api_publish: &api_publish
  executor: my-executor
  steps:
    - attach_workspace:
        # Must be absolute path or relative path from working_directory
        at: .

    - run:
        name: Install Serverless CLI and dependencies
        command: |
            sudo npm i -g serverless
            npm install

    - run:
        name: Publish to AWS
        command: |
            sls deploy --stage $SERVERLESS_RELEASE_CHANNEL
jobs:
  setup:
    executor: my-executor
    steps:
      - checkout

      - run:
          name: Install api dependencies
          command: |
            npm install

      - persist_to_workspace:
          # Must be an absolute path, or relative path from working_directory. This is a directory on the container which is
          # taken to be the root directory of the workspace.
          root: workspace
          # Must be relative path from root
          paths:
            - .
  test_api:
    docker:
      -
        environment:
          PIPENV_VENV_IN_PROJECT: true
        image: "circleci/python:2.7"
    steps:
      - checkout

      - run:
          name: Execute Tests
          command: |
              sudo pip install pipenv
              pipenv install
              pipenv run python -m unittest discover -s bingos/ -p '*_test.py'
      -
        store_test_results:
          path: test-api-results
    working_directory: ~/swayze-life

  api_publish_to_aws_dev:
    environment:
      SERVERLESS_RELEASE_CHANNEL: dev
    <<: *api_publish

  api_publish_to_aws_prod:
    environment:
      SERVERLESS_RELEASE_CHANNEL: prod
    <<: *api_publish

workflows:
  version: 2
  build-and-deploy:
    jobs:
      - setup
      - test_api

      - api_publish_to_aws_dev:
          requires:
            - test_api
            - setup
          filters:
            branches:
              only: development

      - api_publish_to_aws_dev:
          requires:
            - test_api
            - setup
          filters:
            branches:
              only: release
